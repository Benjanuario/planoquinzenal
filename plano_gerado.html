<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Gerador de Plano de Aula</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: 'Times New Roman', Times, serif; font-size:12px; line-height:1.5; background:#f6f6f6; }
    .container { width:100%; max-width:900px; margin:12px auto; background:white; padding:12px; box-shadow:0 2px 6px rgba(0,0,0,.08);}
    h2,h3 { text-align:center; margin:8px 0; font-size:16px;}
    label { display:block; margin-top:6px; font-size:12px;}
    input, select, textarea, button { width:100%; padding:8px; margin-top:2px; border:2px solid black; border-radius:4px; font-size:12px; box-sizing:border-box;}
    button { background:#007bff; color:#fff; cursor:pointer; font-weight:600;}
    button.secondary { background:#28a745; }
    button.warn { background:#ffc107; color:#000;}
    .row { display:flex; gap:8px; flex-wrap:wrap; }
    .col { flex:1; min-width:200px; padding:6px; }
    table { width:100%; border-collapse:collapse; margin-top:10px; font-size:12px; background:#fff;}
    th,td { border:1px solid #000; padding:6px; vertical-align:top; text-align:left; }
    th { background:#6c757d; color:#000; font-weight:700; text-transform:uppercase; font-size:11px;}
    td[contenteditable="true"] { outline: none; }
    /* ---- Ajustes especiais s√≥ para impress√£o/PDF ---- */
@media print {
  #tabelaPlano {
    table-layout: fixed;   /* for√ßa a tabela a respeitar os tamanhos */
    width: 100%;
  }

  #tabelaPlano th, 
  #tabelaPlano td {
    word-wrap: break-word;
    white-space: normal;
    overflow-wrap: break-word;
    font-size: 11px;   /* reduz ligeiramente a fonte no PDF */
  }

  /* Coluna 1 - Tempo */
  #tabelaPlano th:nth-child(1), 
  #tabelaPlano td:nth-child(1) {
    width: 6%; 
    min-width: 60px;
  }

  /* Coluna 2 - Fun√ß√µes Did√°cticas */
  #tabelaPlano th:nth-child(2), 
  #tabelaPlano td:nth-child(2) {
    width: 10%; 
    min-width: 100px;
  }

  /* Coluna 3 - Conte√∫dos */
  #tabelaPlano th:nth-child(3), 
  #tabelaPlano td:nth-child(3) {
    width: 15%; 
    min-width: 120px;
  }

  /* Coluna 4 - Atividades do Professor */
  #tabelaPlano th:nth-child(4), 
  #tabelaPlano td:nth-child(4) {
    width: 23%; 
    min-width: 160px;
  }

  /* Coluna 5 - Atividades dos Alunos */
  #tabelaPlano th:nth-child(5), 
  #tabelaPlano td:nth-child(5) {
    width: 23%; 
    min-width: 160px;
  }

  /* Coluna 6 - M√©todos de Ensino */
  #tabelaPlano th:nth-child(6), 
  #tabelaPlano td:nth-child(6) {
    width: 10%; 
    min-width: 100px;
  }

  /* Coluna 7 - Meios de Ensino */
  #tabelaPlano th:nth-child(7), 
  #tabelaPlano td:nth-child(7) {
    width: 13%; 
    min-width: 120px;
  }
}
    #mensagem { margin-top:8px; font-size:13px; color:#0b6; }
    .novoBloco { border:1px dashed #007bff; padding:8px; margin-top:10px; }
    #botaoSalvarAnexoInferior { display:none; margin-top:10px;}
    .small { font-size:11px; color:#555; margin-top:4px;}
    /* Estilo para os selects de m√©todo de ensino */
    .metodoSelect {
      width: 100%;
      font-size: 11px;
      padding: 2px;
      border: 1px solid #ccc;
      border-radius: 2px;
    }
    /* Impedir sele√ß√£o de texto apenas no preview final (#planoFinal) */
#planoFinal {
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

/* Exce√ß√£o: permitir edi√ß√£o/sele√ß√£o nos campos configurados como edit√°veis */
#planoFinal input,
#planoFinal textarea,
#planoFinal select,
#planoFinal [contenteditable="true"] {
  -webkit-user-select: text !important;
  -moz-user-select: text !important;
  -ms-user-select: text !important;
  user-select: text !important;
}
/* ---- For√ßar p√°gina em modo paisagem no PDF ---- */
@page {
  size: A4 landscape;   /* A4 em modo horizontal */
  margin: 10mm;         /* margem de seguran√ßa para n√£o cortar */
}

@media print {
  body {
    -webkit-print-color-adjust: exact; /* mant√©m as cores no PDF */
    print-color-adjust: exact;
  }
}
  </style>
</head>
<body>
  <div class="container">
    <h2>GERADOR DE PLANO DE AULA</h2>

    <form name="planoForm" onsubmit="event.preventDefault()">
      <div class="row">
        <div class="col">
          <label>Escola:</label><input type="text" name="escola" required />
          <label>Nome do Professor:</label><input type="text" name="professor" required />
          <label>Disciplina:</label><input type="text" name="disciplina" required />
          <label>Unidade Tem√°tica:</label><input type="text" name="unidade" required />
          <label>Tema da Aula:</label><input type="text" name="tema" required maxlength="100" />
          <label>Tipo de Aula:</label><input type="text" name="tipo" required />
        </div>

        <div class="col">
          <label>Classe:</label>
          <select name="classe" required>
            <option value="">Selecione a classe</option>
            <option value="1¬™">1¬™ Classe</option><option value="2¬™">2¬™ Classe</option><option value="3¬™">3¬™ Classe</option>
            <option value="4¬™">4¬™ Classe</option><option value="5¬™">5¬™ Classe</option><option value="6¬™">6¬™ Classe</option>
            <option value="7¬™">7¬™ Classe</option><option value="8¬™">8¬™ Classe</option><option value="9¬™">9¬™ Classe</option>
            <option value="10¬™">10¬™ Classe</option><option value="11¬™">11¬™ Classe</option><option value="12¬™">12¬™ Classe</option>
          </select>
          <label>Turma:</label><input type="text" name="turma" required />
          <label>Li√ß√£o n¬∫:</label><input type="number" name="licao" min="1" step="1" />
          <label>Dura√ß√£o:</label>
          <select name="duracao" required><option value="45">45 minutos</option><option value="90">90 minutos</option></select>
          <label>Per√≠odo:</label>
<select name="periodo" required>
  <option value="">Selecione o per√≠odo</option>
  <option value="Manh√£">Manh√£</option>
  <option value="Tarde">Tarde</option>
  <option value="Noite">Noite</option>
</select>
          <label>Data:</label><input type="date" name="data" required/>
          <label style="margin-top:8px;"><input type="checkbox" id="usarMateriais" onchange="alternarCampoMaterial()"> Aula exige material did√°tico?</label>
          <div id="adicionarMaterialDiv" style="display:none;">
            <label>Adicionar material:</label>
            <div style="display:flex; gap:8px;">
              <input type="text" id="inputMaterial" placeholder="Ex: cartaz, marcador">
              <button type="button" onclick="adicionarMaterial()" style="width:120px;">Adicionar</button>
            </div>
            <ul id="listaMateriais" style="font-size:12px; margin-top:8px;"></ul>
          </div>
        </div>
      </div>

      <div style="margin-top:8px;">
        <label>Objectivos Espec√≠ficos:</label>
        <textarea id="objetivosCampo" name="objetivos" required style="height:90px;"></textarea>
        <div style="display:flex; gap:8px; margin-top:6px;">
          <button type="button" class="secondary" onclick="gerarObjetivosLocal()" style="padding:10px 20px; 
           background: linear-gradient(90deg, #0d6efd, #6610f2);
           color:white; 
           border:none; 
           border-radius:12px; 
           cursor:pointer; 
           font-weight:bold;
           box-shadow: 0 4px 6px rgba(0,0,0,0.2);
           transition: 0.3s;">
    GERAR OBJECTIVOS ESPEC√çFICOS</button>
          <button type="button" class="warn" onclick="gerarNovosObjetivos()" style="padding:10px 20px; 
               background: #ffc107; 
               color:black; 
               border:none; 
               border-radius:12px; 
               cursor:pointer; 
               font-weight:bold;
               box-shadow: 0 4px 6px rgba(0,0,0,0.2);
               transition: 0.3s;">
    ‚ôªÔ∏èALTERAR OBJECTIVOS</button>
        </div>
      </div>

      <div style="margin-top:10px;">
  <button type="button" class="secondary" onclick="iniciarGeracaoPlano()" 
          style="padding:10px 20px; 
                 background: linear-gradient(90deg, #0d6efd, #6610f2);
                 color:white; 
                 border:none; 
                 border-radius:12px; 
                 cursor:pointer; 
                 font-weight:bold;
                 box-shadow: 0 4px 6px rgba(0,0,0,0.2);
                 transition: 0.3s;">
    üìù GERAR PLANO DE AULA
  </button>
</div>
    </form>

    <div id="avisoExportacao" class="small" style="display:none;color:#c00;">‚ö†Ô∏è Exporte o plano em modo horizontal para melhor visualiza√ß√£o em PDF.</div>
    <div id="mensagem"></div>

<!-- Bot√£o voltar ao formul√°rio -->
<button id="btnVoltarFormulario" onclick="voltarAoFormulario()" style="display:none; margin-bottom:10px;">
  VOLTAR AO FORMUL√ÅRIO üëÜ
</button>

<!-- PREVIEW / PLANO -->
<div id="planoFinal" style="display:none; margin-top:16px;">
  <h3>PLANO DE AULA</h3>
      <div class="row">
        <div class="col" id="dadosEsquerda"></div>
        <div class="col" id="dadosDireita"></div>
      </div>

      <h4>Objetivos Espec√≠ficos:</h4>
      <ul id="listaObjetivos"></ul>

      <table id="tabelaPlano" aria-label="Tabela do plano">
        <thead>
          <tr>
            <th>TEMPO</th>
            <th>FUN√á√ïES DID√ÅCTICAS</th>
            <th>CONTE√öDOS</th>
            <th>ACTIVIDADES DO PROFESSOR</th>
            <th>ACTIVIDADES DOS ALUNOS</th>
            <th>M√âTODOS DE ENSINO</th>
            <th>MEIOS DE ENSINO</th>
          </tr>
        </thead>
        <tbody id="tabelaCorpo"></tbody>
      </table>
      </table>

<!-- Controles de Anexo -->
<button id="btnAdicionarAnexo" type="button" onclick="abrirAnexo()"
    style="padding:10px 20px; 
           background: linear-gradient(90deg, #0d6efd, #6610f2);
           color:white; 
           border:none; 
           border-radius:12px; 
           cursor:pointer; 
           font-weight:bold;
           box-shadow: 0 4px 6px rgba(0,0,0,0.2);
           transition: 0.3s;">
    üìãADICIONAR ANEXO (Opcional)üñá
</button>

<script>
  const btn = document.getElementById("btnAdicionarAnexo");
  btn.onmouseover = () => btn.style.transform = "scale(1.05)";
  btn.onmouseout = () => btn.style.transform = "scale(1)";
</script>

<!-- Container visual do anexo salvo -->
<div id="anexoPreview" style="margin-top:12px; border:2px solid #000; border-radius:8px; padding:10px; display:none;">
  <h4 style="margin-top:0; color:#222; border-bottom:1px solid #000; padding-bottom:4px;">Anexo</h4>
  <div id="anexoContent">(Nenhum anexo adicionado)</div>
  <div id="anexoControls"></div> <!-- Necess√°rio para o bot√£o aparecer -->
</div>
      <div style="margin-to;">
        <Benjanuario type="button" onclick="abrirNovoBloco()">
        <div id="novoBlocoContainer"></div>
      </div>
        <button type="button" onclick="irParaPagamento()" style="padding:10px 20px; 
           background: linear-gradient(90deg, #0d6efd, #6610f2);
           color:white; 
           border:none; 
           border-radius:12px; 
           cursor:pointer; 
           font-weight:bold;
           box-shadow: 0 4px 6px rgba(0,0,0,0.2);
           transition: 0.3s;">
    üì•EXPORTAR PDF (BAIXAR O PLANO) = 5 Mts
</button>
      </div>
    </div>
  </div>
<!-- LOADER MODERNO -->
<div id="loaderPlano" style="display:none; flex-direction: column; align-items: center; justify-content: center; margin:20px 0;">
  <div class="circle" style="width:120px; height:120px; border:10px solid #ddd; border-top:10px solid #4CAF50; border-radius:50%; position:relative; animation: spin 1s linear infinite;">
    <div class="percentage" id="percentText" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:20px; font-weight:bold;">0%</div>
  </div>
  <div class="message" id="loaderMessage" style="margin-top:20px; font-size:16px; font-style:italic;">Iniciando...</div>

  <!-- BOT√ÉO vis√≠vel DURANTE o loader -->
  <button id="loaderVoltarBtn" style="display:none; margin-top:12px; padding:8px 12px; border-radius:6px; border:1px solid #ccc; background:#6610f2; cursor:pointer;"
          onclick="cancelarLoader()">‚ùåCANCELAR O PROCESSO EM EXECU√á√ÉO</button>
</div>

<style>
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>
<script>
/* ---------- dados e constantes ---------- */
const verbosCognitivos = [
  "identificar","descrever","classificar","definir","explicar","relacionar",
  "enumerar","comparar","analisar","sintetizar",
  "calcular","resolver","avaliar","formular","demonstrar","interpretar",
  "justificar","estimar"
];

const verbosPsicomotores = [
  "desenhar","montar","construir","organizar","manipular","demonstrar",
  "executar","medir","simular","experimentar",
  "esquematizar","operar","reproduzir","registrar","representar","diagramar",
  "preparar","tra√ßar"
];

const verbosAfetivos = [
  "valorizar","respeitar","cooperar","participar","aceitar","comprometer-se",
  "defender","refletir","apreciar","internalizar",
  "colaborar","compartilhar","questionar","sensibilizar-se","incentivar",
  "considerar","estimular"
];
const metodosEnsino = [
  "Elabora√ß√£o conjunta","Expositivo-Explicativo","Trabalho Independente",
  "Trabalho em Grupo","Participativo / Interativo","Demonstrativo / Pr√°tico",
  "Resolu√ß√£o de Problemas"
];

let materiais = [];
let imagemDataURL = null;
// torna a vari√°vel global (var cria propriedade em window)
var anexoSalvo = window.anexoSalvo || null;

// ======= Bloquear c√≥pia s√≥ no preview =======
(function(){
  const plano = document.getElementById('planoFinal');
  if (!plano) return;

  // Bloqueia clique direito dentro do preview
  plano.addEventListener('contextmenu', function(e){
    e.preventDefault();
  });

  // Bloqueia Ctrl+C, Ctrl+X, Ctrl+U apenas no preview
  document.addEventListener('keydown', function(e){
    const inside = plano.contains(document.activeElement) || plano === document.activeElement;
    if (!inside) return;
    if ((e.ctrlKey || e.metaKey) && ["c","x","s","u"].includes(e.key.toLowerCase())) {
      e.preventDefault();
    }
  });
})();

/* ---------- utilit√°rios ---------- */
function escapeHtml(str){
  if (!str) return '';
  return String(str).replace(/&/g,'&amp;').replace(/</g,'<').replace(/>/g,'>').replace(/"/g,'&quot;');
}

function mostrarMensagem(msg){
  const el = document.getElementById('mensagem');
  el.textContent = msg;
  el.style.color = '#0b6';
  setTimeout(()=>el.textContent='', 4000);
}

function criarSelectMetodo(selected){
  const id = 'metodo_' + Math.random().toString(36).substr(2, 9);
  let s = `<select class="metodoSelect" id="${id}" onchange="mostrarMetodoEscolhido(this)">`;
  s += `<option value="">-- Selecione --</option>`;
  for (const m of metodosEnsino){
    s += `<option value="${m}" ${m === selected ? 'selected' : ''}>${m}</option>`;
  }
  s += `</select>`;
  // Texto exibido logo abaixo do select
  s += `<div class="metodoEscolhidoTexto" style="font-size:11px;color:#007bff;margin-top:4px;">${selected || ""}</div>`;
  return s;
}
function mostrarMetodoEscolhido(selectEl){
  const container = selectEl.nextElementSibling;
  container.textContent = selectEl.value || "";
}

/* ---------- Materiais ---------- */
function alternarCampoMaterial(){
  document.getElementById('adicionarMaterialDiv').style.display = document.getElementById('usarMateriais').checked ? 'block' : 'none';
}
function adicionarMaterial(){
  if (materiais.length >= 4) {
    alert('S√≥ √© permitido adicionar no m√°ximo 4 materiais did√°ticos.');
    return;
  }

  const input = document.getElementById('inputMaterial');
  const valor = input.value.trim();
  if (!valor) { 
    alert('Escreve o material antes de adicionar.'); 
    return; 
  }
  materiais.push(valor);
  const li = document.createElement('li');
  li.textContent = valor;
  document.getElementById('listaMateriais').appendChild(li);
  input.value = '';
  mostrarMensagem('Material adicionado.');
}

/* ---------- Objetivos ---------- */
function gerarObjetivosLocal(){
  const tema = document.forms['planoForm'].tema.value.trim();
  if (!tema){ 
    alert("Por favor, preencha o tema da aula primeiro."); 
    return; 
  }
  gerarNovosObjetivos();
}

function gerarNovosObjetivos(){
  const tema = document.forms['planoForm'].tema.value.trim();
  if (!tema) return;

  const vC = verbosCognitivos[Math.floor(Math.random()*verbosCognitivos.length)];
  const vP = verbosPsicomotores[Math.floor(Math.random()*verbosPsicomotores.length)];
  const vA = verbosAfetivos[Math.floor(Math.random()*verbosAfetivos.length)];

  const objetivos = [
    `${vC.charAt(0).toUpperCase()+vC.slice(1)} os conceitos fundamentais de "${tema}"`,
    `${vP.charAt(0).toUpperCase()+vP.slice(1)} uma actividade pr√°tica relacionada a "${tema}"`,
    `${vA.charAt(0).toUpperCase()+vA.slice(1)} a import√¢ncia de "${tema}" no contexto social`
  ];

  document.getElementById('objetivosCampo').value = objetivos.join(";\n");
  mostrarMensagem('Objectivos gerados.');
}
// Vari√°vel global para controlar o interval do loader
let _planoLoaderInterval = null;

// Cancela o loader em execu√ß√£o e restaura o formul√°rio
function cancelarLoader() {
  // limpa interval se estiver a correr
  if (_planoLoaderInterval) {
    clearInterval(_planoLoaderInterval);
    _planoLoaderInterval = null;
  }

  // esconde o loader (se vis√≠vel)
  const loader = document.getElementById('loaderPlano');
  if (loader) loader.style.display = 'none';

  // esconde o bot√£o dentro do loader
  const loaderVoltar = document.getElementById('loaderVoltarBtn');
  if (loaderVoltar) loaderVoltar.style.display = 'none';

  // mostra o formul√°rio de novo
  const form = document.forms['planoForm'];
  if (form) form.style.display = 'block';

  // garante que o preview/planoFinal fica escondido
  const planoFinal = document.getElementById('planoFinal');
  if (planoFinal) planoFinal.style.display = 'none';

  // mostra tamb√©m o bot√£o de voltar (caso queira usar)
  const fallbackBtn = document.getElementById('btnVoltarFormulario');
  if (fallbackBtn) fallbackBtn.style.display = 'inline-block';
}
function mostrarLoader(callback) {
  const loader = document.getElementById('loaderPlano');
  const percentText = document.getElementById('percentText');
  const loaderMessage = document.getElementById('loaderMessage');
  const loaderVoltar = document.getElementById('loaderVoltarBtn');

  // mostra o loader e o bot√£o "Voltar ao Formul√°rio" (durante o processamento)
  loader.style.display = 'flex';
  if (loaderVoltar) loaderVoltar.style.display = 'inline-block';

  percentText.textContent = '0%';
  loaderMessage.textContent = 'Iniciando...';

  let progress = 0;
  const messages = [
    { msg: "Coletando Dados...", perc: 25 },
    { msg: "Fazendo o Plano de Aula...", perc: 50 },
    { msg: "Determinando M√©todos de Ensino...", perc: 75 },
    { msg: "Finalizando o Plano...", perc: 100 }
  ];
  let currentMsgIndex = 0;

  const interval = setInterval(() => {
    progress++;
    percentText.textContent = progress + '%';

    if (progress >= messages[currentMsgIndex].perc) {
      loaderMessage.textContent = messages[currentMsgIndex].msg;
      currentMsgIndex++;
    }

    if (progress >= 100) {
      clearInterval(interval);
      _planoLoaderInterval = null;
      setTimeout(() => {
        // esconde o bot√£o do loader antes de continuar
        if (loaderVoltar) loaderVoltar.style.display = 'none';
        loader.style.display = 'none';
        if (callback) callback(); // chama o callback (ex.: gerarPlano)
      }, 500);
    }
  }, 60);

  // guarda o interval globalmente para podermos cancel√°-lo
  _planoLoaderInterval = interval;
}

function iniciarGeracaoPlano() {
  document.forms['planoForm'].style.display = 'none';
  document.getElementById('planoFinal').style.display = 'none';
  
  mostrarLoader(gerarPlano);
}
function cancelarLoader() {
  if (typeof _planoLoaderInterval !== "undefined" && _planoLoaderInterval) {
    clearInterval(_planoLoaderInterval);
    _planoLoaderInterval = null;
  }

  const loader = document.getElementById('loaderPlano');
  if (loader) loader.style.display = 'none';

  const voltarBtn = document.getElementById('loaderVoltarBtn');
  if (voltarBtn) voltarBtn.style.display = 'none';

  const form = document.forms['planoForm'];
  if (form) form.style.display = 'block';

  const planoFinal = document.getElementById('planoFinal');
  if (planoFinal) planoFinal.style.display = 'none';
}

/* ---------- Gerar Plano ---------- */
function gerarPlano(){
  const form = document.forms['planoForm'];

// üîπ Valida√ß√£o dos campos obrigat√≥rios
const requiredFields = ['escola', 'professor', 'disciplina', 'tema', 'classe', 'turma', 'duracao', 'data'];
for (const fieldName of requiredFields) {
  if (!form[fieldName].value.trim()) {
    alert(`O campo "${fieldName}" √© obrigat√≥rio.`);
    form[fieldName].focus();
    cancelarLoader(); // cancela o loader e volta ao formul√°rio
    return;
  }
}

  // Cabe√ßalhos
  document.getElementById('dadosEsquerda').innerHTML = `
    <p><strong>Escola:</strong> ${escapeHtml(form.escola.value)}</p>
    <p><strong>Professor:</strong> ${escapeHtml(form.professor.value)}</p>
    <p><strong>Disciplina:</strong> ${escapeHtml(form.disciplina.value)}</p>
    <p><strong>Unidade Tem√°tica:</strong> ${escapeHtml(form.unidade.value)}</p>
    <p><strong>Tema:</strong> ${escapeHtml(form.tema.value)}</p>
    <p><strong>Tipo de Aula:</strong> ${escapeHtml(form.tipo.value)}</p>`;

  document.getElementById('dadosDireita').innerHTML = `
    <p><strong>Classe:</strong> ${escapeHtml(form.classe.value)}</p>
    <p><strong>Turma:</strong> ${escapeHtml(form.turma.value)}</p>
    <p><strong>Li√ß√£o n¬∫:</strong> ${escapeHtml(form.licao.value || "‚Äî")}</p>
    <p><strong>Dura√ß√£o:</strong> ${escapeHtml(form.duracao.value)} minutos</p>
    <p><strong>Per√≠odo:</strong> ${escapeHtml(form.periodo.value)}</p>
    <p><strong>Data:</strong> ${form.data.value}</p>
    ${materiais.length ? `<p><strong>Materiais:</strong><br>${materiais.map(m => `‚Ä¢ ${escapeHtml(m)}`).join('<br>')}</p>` : ''}`;

  // Objetivos
  const objetivosText = form.objetivos.value.trim();
  document.getElementById('listaObjetivos').innerHTML = objetivosText ? objetivosText.split(';\n').map(l=>`<li>${escapeHtml(l)}</li>`).join('') : '';

  // --- TABELA (CORPO) ---
  const classeNum = String(form.classe.value || '').replace(/[^\d]/g,'');
  const isClasseInicial = (classeNum === '1' || classeNum === '2');
  const meiosEnsinoIniciais = 'Livro do aluno';
  const meiosEnsinoNormais = 'Quadro, giz, livro do aluno, esferogr√°fica';
  const duracao = parseInt(form.duracao.value || 45, 10);
  const fator = duracao === 90 ? 2 : 1;
  const tempo1 = `${5 * fator} min`, tempo2 = `${20 * fator} min`, tempo3 = `${10 * fator} min`, tempo4 = `${10 * fator} min`;

  const tabelaCorpo = document.getElementById('tabelaCorpo');
  tabelaCorpo.innerHTML = `
    <tr data-funcao="Introdu√ß√£o e Motiva√ß√£o">
      <td>${escapeHtml(tempo1)}</td>
      <td><strong>Introdu√ß√£o e Motiva√ß√£o</strong></td>
      <td contenteditable="true">‚Ä¢ Sauda√ß√£o<br>‚Ä¢ Marca√ß√£o de presen√ßa<br>‚Ä¢ Recapitula√ß√£o da aula anterior<br>‚Ä¢ Apresenta√ß√£o do tema "${escapeHtml(form.tema.value)}"</td>
      <td contenteditable="true">‚Ä¢ Sa√∫da os alunos<br>‚Ä¢ Faz a marca√ß√£o de presen√ßas<br>‚Ä¢ Orienta a recapitula√ß√£o da aula anterior<br>‚Ä¢ Introduz o tema "${escapeHtml(form.tema.value)}"</td>
      <td contenteditable="true">‚Ä¢ Sa√∫dam o professor<br>‚Ä¢ Confirma a presen√ßa<br>‚Ä¢ Recapitulam a aula anterior sob orienta√ß√£o do professor<br>‚Ä¢ Anotam o tema</td>
      <td>${criarSelectMetodo("Elabora√ß√£o conjunta")}</td>
      <td contenteditable="true">${isClasseInicial ? meiosEnsinoIniciais : meiosEnsinoNormais}</td>
    </tr>
    <tr data-funcao="Media√ß√£o e Assimila√ß√£o">
      <td>${escapeHtml(tempo2)}</td>
      <td>Media√ß√£o e Assimila√ß√£o</td>
      <td contenteditable="true">‚Ä¢ Explora√ß√£o dos poss√≠veis pressupostos dos alunos<br>‚Ä¢ Explica√ß√£o do tema "${escapeHtml(form.tema.value)}"<br>‚Ä¢ Esclarecimento das poss√≠veis d√∫vidas</td>
      <td contenteditable="true">‚Ä¢ Explora poss√≠veis ideias dos alunos<br>‚Ä¢ Explica o conte√∫do<br>‚Ä¢ Procura sanar as poss√≠veis d√∫vidas<br>‚Ä¢ Passa o apontamento no quadro</td>
      <td contenteditable="true">‚Ä¢ Exp√µem as poss√≠veis ideias<br>‚Ä¢ Prestam aten√ß√£o na explica√ß√£o<br>‚Ä¢ Exp√µem as poss√≠veis d√∫vidas relacionadas ao tema<br>‚Ä¢ Transcrevem o apontamento para os seus cadernos</td>
      <td>${criarSelectMetodo("Elabora√ß√£o conjunta")}</td>
      <td contenteditable="true">${isClasseInicial ? meiosEnsinoIniciais : 'Quadro, giz, livro do aluno, cartaz'}</td>
    </tr>
    <tr data-funcao="Dom√≠nio e Consolida√ß√£o">
      <td>${escapeHtml(tempo3)}</td>
      <td>Dom√≠nio e Consolida√ß√£o</td>
      <td contenteditable="true">‚Ä¢Exerc√≠cios de aplica√ß√£o<br>‚Ä¢ Verifica√ß√£o da resolu√ß√£o dos exerc√≠cios</td>
      <td contenteditable="true">‚Ä¢ Passa os exerc√≠cios no quadro<br>‚Ä¢ Orienta a resolu√ß√£o dos exerc√≠cios<br>‚Ä¢ Passa de carteira em carteira a verificar a resolu√ß√£o</td>
      <td contenteditable="true">‚Ä¢ Transcrevem os exerc√≠cios aos cadernos<br>‚Ä¢ Resolvem os exerc√≠cios no ${isClasseInicial ? 'livro do aluno' : 'caderno'} individualmente</td>
      <td>${criarSelectMetodo("Trabalho Independente")}</td>
      <td contenteditable="true">${isClasseInicial ? meiosEnsinoIniciais : 'Caderno, esferogr√°fica, livro do aluno'}</td>
    </tr>
    <tr data-funcao="Controlo e Avalia√ß√£o">
      <td>${escapeHtml(tempo4)}</td>
      <td>Controlo e Avalia√ß√£o</td>
      <td contenteditable="true">‚Ä¢ Corre√ß√£o dos exerc√≠cios<br>‚Ä¢ Breve resumo da aula<br>‚Ä¢ Marca√ß√£o do TPC</td>
      <td contenteditable="true">‚Ä¢ Corrige os exerc√≠cios apresentados<br>‚Ä¢ Resume os pontos principais<br>‚Ä¢ Faz a marca√ß√£o do TPC</td>
      <td contenteditable="true">‚Ä¢ Apresentam os exerc√≠cios corrigidos<br>‚Ä¢ Prestam aten√ß√£o e anotam o resumo<br>‚Ä¢ Anotam o TPC no ${isClasseInicial ? 'livro do aluno' : 'caderno'}</td>
      <td>${criarSelectMetodo("Trabalho Independente")}</td>
      <td contenteditable="true">${isClasseInicial ? meiosEnsinoIniciais : 'Quadro, caderno, esferogr√°fica, apagador'}</td>
    </tr>`;

  // Mostrar preview
  document.getElementById('planoFinal').style.display = 'block';
  document.getElementById('btnVoltarFormulario').style.display = 'inline-block'; // ‚Üê mostra bot√£o
  document.forms['planoForm'].style.display = 'none'; // ‚Üê esconde formul√°rio
  document.getElementById('avisoExportacao').style.display = 'block';
  setTimeout(()=>document.getElementById('avisoExportacao').style.display='none', 9000);
  // Salvar plano
  atualizarPlanoSalvo();
  mostrarMensagem('Plano gerado e salvo na sess√£o.');
  atualizarBotaoAnexoInferior();
  const planoData = {
  disciplina: form.disciplina.value,
  classe: form.classe.value,
  data: form.data.value,
  html: document.getElementById('planoFinal').innerHTML,
  anexoSalvo: anexoSalvo || null
};
sessionStorage.setItem("planoData", JSON.stringify(planoData));
}

/* ---------- Fun√ß√£o Voltar ao Formul√°rio ---------- */
function voltarAoFormulario() {
  const form = document.forms['planoForm'];
  form.style.display = 'block';
  document.getElementById('planoFinal').style.display = 'none';
  document.getElementById('btnVoltarFormulario').style.display = 'none';
}
function irParaPagamento() {
  // Substituir selects por apenas o texto do m√©todo escolhido (s√≥ na exporta√ß√£o)
  const selects = document.querySelectorAll('#tabelaPlano select.metodoSelect');
  selects.forEach(sel => {
    const td = sel.parentElement;
    const texto = sel.value || "‚Äî";
    td.innerHTML = texto; // remove o select e mant√©m s√≥ o m√©todo escolhido
  });

  // Salva todos os dados necess√°rios, incluindo o HTML completo do preview!
  const planoData = {
    escola: document.forms['planoForm'].escola.value,
    professor: document.forms['planoForm'].professor.value,
    disciplina: document.forms['planoForm'].disciplina.value,
    unidade: document.forms['planoForm'].unidade.value,
    tema: document.forms['planoForm'].tema.value,
    tipo: document.forms['planoForm'].tipo.value,
    classe: document.forms['planoForm'].classe.value,
    turma: document.forms['planoForm'].turma.value,
    licao: document.forms['planoForm'].licao.value,
    duracao: document.forms['planoForm'].duracao.value,
    periodo: document.forms['planoForm'].periodo.value,
    data: document.forms['planoForm'].data.value,
    materiais: materiais,
    objetivos: document.getElementById('objetivosCampo').value,
    tabela: document.getElementById('tabelaPlano').outerHTML,
    anexoTipo: anexoSalvo ? anexoSalvo.tipo : null,
    anexoImagem: (anexoSalvo && anexoSalvo.tipo === 'imagem') ? anexoSalvo.data : null,
    anexoTexto: (anexoSalvo && anexoSalvo.tipo === 'texto') ? anexoSalvo.data : "",
    // ESSENCIAL: salva o HTML completo do preview!
    html: document.getElementById('planoFinal').innerHTML
  };
console.log('Salvando planoData para pagamento ‚Äî anexoTipo:', planoData.anexoTipo, 'hasImage?', !!planoData.anexoImagem, 'hasText?', !!planoData.anexoTexto);
sessionStorage.setItem("planoData", JSON.stringify(planoData));
  // Salva os dados para o pagamento.html recuperar
  sessionStorage.setItem("planoData", JSON.stringify(planoData));

  // Vai para a tela de pagamento
  window.location.href = "pagamento.html";
}
</script>
<!-- container que receber√° o anexo.html (fica escondido at√© abrir) -->
<div id="anexoContainerContent" style="display:none; margin-top:15px;"></div>

<script>
  // Carregar interface e l√≥gica do Anexo de forma segura:
  (function loadAnexoWithCropper() {
    // 1) garante CSS do Cropper
    if (!document.getElementById('cropperCss')) {
      const link = document.createElement('link');
      link.id = 'cropperCss';
      link.rel = 'stylesheet';
      link.href = 'https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css';
      document.head.appendChild(link);
    }

    // 2) busca o anexo.html e injeta
    fetch('anexo.html')
      .then(res => res.text())
      .then(html => {
        document.getElementById('anexoContainerContent').innerHTML = html;

        // 3) carrega o script do Cropper (se necess√°rio) e s√≥ depois carrega anexo.js
        function loadAnexoJs() {
          const s = document.createElement('script');
          s.src = 'anexo.js';
          document.body.appendChild(s);
        }

        if (typeof Cropper === 'undefined') {
          // carrega cropper.js dinamicamente
          const sCrop = document.createElement('script');
          sCrop.src = 'https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js';
          sCrop.onload = loadAnexoJs;
          sCrop.onerror = function(){
            console.error('Erro ao carregar Cropper.js');
            loadAnexoJs(); // tenta carregar anexo.js de qualquer forma (mas avisa)
          };
          document.head.appendChild(sCrop);
        } else {
          loadAnexoJs();
        }
      })
      .catch(err => console.error('Erro ao carregar anexo.html:', err));
  })();
</script>
</body>
</html>
