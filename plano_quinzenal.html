<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Plano Quinzenal</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body {
      font-family: 'Times New Roman', Times, serif;
      font-size: 12px;
      line-height: 1.5;
      background: #f6f6f6;
      margin: 0;
      padding: 0;
    }
    .container {
      width: 100%;
      max-width: 900px;
      margin: 12px auto;
      background: white;
      padding: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,.08);
    }
    label {
      display: block;
      margin-top: 6px;
      font-size: 12px;
      font-family: 'Times New Roman', Times, serif;
    }
    input, select, button {
      width: 100%;
      padding: 8px;
      margin-top: 2px;
      border: 2px solid black;
      border-radius: 4px;
      font-size: 12px;
      font-family: 'Times New Roman', Times, serif;
      box-sizing: border-box;
    }
    button {
      background: #007bff;
      color: #fff;
      cursor: pointer;
      font-weight: 600;
    }
    .row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .col {
      flex: 1;
      min-width: 200px;
      padding: 6px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 12px;
      background: #fff;
    }
    th, td {
      border: 1px solid #000;
      padding: 6px;
      vertical-align: top;
      text-align: left;
    }
    th {
      background: #6c757d;
      color: #000;
      font-weight: 700;
      text-transform: uppercase;
      font-size: 11px;
    }
    td[contenteditable="true"] {
      outline: none;
    }
    #planoFinal {
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }
    #planoFinal [contenteditable="true"] {
      -webkit-user-select: text !important;
      -moz-user-select: text !important;
      -ms-user-select: text !important;
      user-select: text !important;
    }
    @media print {
      @page {
        size: A4 landscape;
        margin: 10mm;
      }
      #tabelaPlano {
        table-layout: fixed;
        width: 100%;
      }
      #tabelaPlano th,
      #tabelaPlano td {
        word-wrap: break-word;
        white-space: normal;
        font-size: 11px;
      }
      #tabelaPlano th:nth-child(1),
      #tabelaPlano td:nth-child(1) { width: 10%; }
      #tabelaPlano th:nth-child(2),
      #tabelaPlano td:nth-child(2) { width: 15%; }
      #tabelaPlano th:nth-child(3),
      #tabelaPlano td:nth-child(3) { width: 20%; }
      #tabelaPlano th:nth-child(4),
      #tabelaPlano td:nth-child(4) { width: 20%; }
      #tabelaPlano th:nth-child(5),
      #tabelaPlano td:nth-child(5) { width: 20%; }
      #tabelaPlano th:nth-child(6),
      #tabelaPlano td:nth-child(6) { width: 15%; }
    }
    #loader {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(255,255,255,0.95);
      z-index: 2000;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    .loader-circle {
      width: 80px; height: 80px;
      border: 8px solid #eee;
      border-top: 8px solid #007BFF;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    #loader-text {
      font-size: 16px;
      font-weight: bold;
      color: #333;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Botão de voltar substitui o título -->
    <button id="btnVoltarFormulario" onclick="voltarAoFormulario()" style="display:none; margin-bottom:10px;">
      VOLTAR AO FORMULÁRIO 👆
    </button>

    <form id="formPlanoQuinzenal" style="display:block;">
      <div class="row">
        <div class="col">
          <label>ZIP:</label>
          <input type="text" id="zipNome" placeholder="Nome da ZIP" required />
          <label>Nº:</label>
          <input type="text" id="zipNumero" placeholder="Número da ZIP" required />
          <label>Classe:</label>
          <select id="classe" required>
            <option value="">Selecione</option>
            <option value="1ª Classe">1ª Classe</option>
            <option value="2ª Classe">2ª Classe</option>
            <option value="3ª Classe">3ª Classe</option>
            <option value="4ª Classe">4ª Classe</option>
            <option value="5ª Classe">5ª Classe</option>
            <option value="6ª Classe">6ª Classe</option>
            <option value="7ª Classe">7ª Classe</option>
            <option value="8ª Classe">8ª Classe</option>
            <option value="9ª Classe">9ª Classe</option>
            <option value="10ª Classe">10ª Classe</option>
            <option value="11ª Classe">11ª Classe</option>
            <option value="12ª Classe">12ª Classe</option>
          </select>
          <label>Disciplina:</label>
          <select id="disciplina" required></select>
          <label>Trimestre:</label>
          <select id="trimestre" required>
            <option value="1º Trimestre">1º Trimestre</option>
            <option value="2º Trimestre">2º Trimestre</option>
            <option value="3º Trimestre">3º Trimestre</option>
          </select>
          <label>Semana de:</label>
          <select id="semanaDe" required></select>
          <label>Semana até:</label>
          <select id="semanaAte" required></select>
        </div>
      </div>
      <button type="button" onclick="iniciarGeracaoPlano()" style="margin-top:16px;">
        Gerar Plano Quinzenal
      </button>
    </form>

    <div id="loader">
      <div class="loader-circle"></div>
      <div id="loader-text">Iniciando...</div>
    </div>

    <div id="planoFinal" style="display:none; text-align:center; margin-top:20px;">
      <h3>PLANO QUINZENAL</h3>
      <div id="cabecalhoZip" style="text-align:center; margin-bottom:12px; font-weight:bold;"></div>
      <table id="tabelaPlano">
        <thead>
          <tr>
            <th>SEMANA</th>
            <th>UNIDADE TEMÁTICA</th>
            <th>OBJECTIVOS ESPECÍFICOS</th>
            <th>CONTEÚDOS</th>
            <th>COMPETÊNCIAS BÁSICAS</th>
            <th>C.H.</th>
          </tr>
        </thead>
        <tbody id="tabelaCorpo"></tbody>
      </table>
      <button onclick="irParaPagamento()" style="margin-top:12px; background:#d32f2f; color:white;">
        📥 Exportar PDF (5 Mts)
      </button>
    </div>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbx03POdfiCoZoMxJpWQFhVfGNSqb5kp_NTzb23H_EOExTJptWndlS9jpJsOywDlEBZN4Q/exec";

    const disciplinasPorClasse = {
      "1ª Classe":["Português","Matemática","Educação Física"],
      "2ª Classe":["Português","Matemática","Educação Física"],
      "3ª Classe":["Português","Matemática","Educação Física"],
      "4ª Classe":["Português","Matemática","Ciências Naturais","Ciências Sociais","Educação Física"],
      "5ª Classe":["Português","Matemática","Ciências Naturais","Ciências Sociais","Educação Visual e Ofícios","Educação Física"],
      "6ª Classe":["Português","Matemática","Ciências Naturais","Ciências Sociais","Educação Visual e Ofícios","Educação Física"],
      "7ª Classe":["Português","Matemática","Biologia","Química","Física","Geografia","História","TIC","Inglês","Educação Visual","Educação Física"],
      "8ª Classe":["Português","Matemática","Biologia","Química","Física","Geografia","História","TIC","Inglês","Educação Visual","Educação Física"],
      "9ª Classe":["Português","Matemática","Biologia","Química","Física","Geografia","História","TIC","Inglês","Educação Visual","Educação Física"],
      "10ª Classe":["Português","Matemática","Biologia","Química","Física","Geografia","História","TIC","Inglês","Francês","Noções de Empreendedorismo","Educação Visual","Educação Física"],
      "11ª Classe":["Português","Matemática","Biologia","Química","Física","Geografia","História","TIC","Inglês","Francês","Filosofia","Noções de Empreendedorismo","EVT","DGD","Educação Física"],
      "12ª Classe":["Português","Matemática","Biologia","Química","Física","Geografia","História","TIC","Inglês","Francês","Filosofia","Noções de Empreendedorismo","EVT","DGD","Educação Física"]
    };

    function preencherSemanas(id) {
      const sel = document.getElementById(id);
      sel.innerHTML = '';
      for (let i = 1; i <= 13; i++) {
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = `${i}ª Semana`;
        sel.appendChild(opt);
      }
    }

    function atualizarDisciplinas() {
      const c = document.getElementById('classe').value;
      const d = document.getElementById('disciplina');
      const disc = disciplinasPorClasse[c] || [];
      d.innerHTML = '';
      disc.forEach(nome => {
        const opt = document.createElement('option');
        opt.value = nome;
        opt.textContent = nome;
        d.appendChild(opt);
      });
    }

    window.addEventListener('DOMContentLoaded', () => {
      preencherSemanas('semanaDe');
      preencherSemanas('semanaAte');
      document.getElementById('classe').addEventListener('change', atualizarDisciplinas);
      document.getElementById('classe').value = "1ª Classe";
      atualizarDisciplinas();
    });

    function voltarAoFormulario() {
      document.getElementById('formPlanoQuinzenal').style.display = 'block';
      document.getElementById('planoFinal').style.display = 'none';
      document.getElementById('btnVoltarFormulario').style.display = 'none';
    }

    function irParaPagamento() {
      const planoData = {
        zipNome: document.getElementById('zipNome').value,
        zipNumero: document.getElementById('zipNumero').value,
        classe: document.getElementById('classe').value,
        disciplina: document.getElementById('disciplina').value,
        trimestre: document.getElementById('trimestre').value,
        html: document.getElementById('planoFinal').innerHTML
      };
      sessionStorage.setItem("planoData", JSON.stringify(planoData));
      window.location.href = "pagamento.html";
    }

    function iniciarGeracaoPlano() {
      const zipNome = document.getElementById('zipNome').value.trim();
      const zipNum = document.getElementById('zipNumero').value.trim();
      const de = parseInt(document.getElementById('semanaDe').value);
      const ate = parseInt(document.getElementById('semanaAte').value);

      if (!zipNome || !zipNum) {
        alert("Preencha o nome e o número da ZIP.");
        return;
      }
      if (de > ate) {
        alert("Semana inicial não pode ser maior que a final.");
        return;
      }
      if (ate - de + 1 >= 4) {
        alert("⚠️ Seleccione Intervalo de Três Semanas no Máximo");
        return;
      }

      document.getElementById('formPlanoQuinzenal').style.display = 'none';
      const loader = document.getElementById('loader');
      const loaderText = document.getElementById('loader-text');
      loader.style.display = 'flex';

      const etapas = [
        { msg: "Coletando dados...", tempo: 3000 },
        { msg: "Estruturando o plano...", tempo: 2500 },
        { msg: "Formatando tabela...", tempo: 2500 },
        { msg: "Finalizando...", tempo: 3000 },
        { msg: "Plano pronto! ✅", tempo: 2000 },
        { msg: "Aguarde a visualização...🖇️", tempo: 1500 },
      ];

      let total = 0;
      etapas.forEach((etapa, i) => {
        setTimeout(() => {
          loaderText.textContent = etapa.msg;
          if (i === etapas.length - 1) {
            setTimeout(() => {
              loader.style.display = 'none';
              gerarPlano();
            }, etapa.tempo);
          }
        }, total);
        total += etapa.tempo;
      });
    }

    async function gerarPlano() {
      const c = document.getElementById('classe').value;
      const d = document.getElementById('disciplina').value;
      const t = document.getElementById('trimestre').value;
      const de = parseInt(document.getElementById('semanaDe').value);
      const ate = parseInt(document.getElementById('semanaAte').value);
      const zipNome = document.getElementById('zipNome').value;
      const zipNum = document.getElementById('zipNumero').value;
      const ano = new Date().getFullYear();

      const semanas = [];
      for (let i = de; i <= ate; i++) {
        semanas.push(i);
      }

      try {
        const url = `${API_URL}?classe=${encodeURIComponent(c)}&disciplina=${encodeURIComponent(d)}&trimestre=${encodeURIComponent(t)}&semanaDe=${de}&semanaAte=${ate}`;
        const res = await fetch(url);
        const planos = await res.json();
        const filtrados = planos.filter(p => semanas.includes(p.numero));

        document.getElementById('cabecalhoZip').innerHTML = `
          Zip: ${zipNome} – Nº: ${zipNum}<br>
          Dosificação Quinzenal de "${d}" – "${c}", ${t} / ${ano}
        `;

        const tbody = document.getElementById('tabelaCorpo');
        tbody.innerHTML = '';

        if (filtrados.length === 0) {
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = 6;
          td.textContent = "Nenhum plano encontrado.";
          td.style.textAlign = "center";
          tr.appendChild(td);
          tbody.appendChild(tr);
        } else {
          filtrados.forEach(p => {
            const dataTexto = `Data: De: __/__/${ano} até: __/__/${ano}`;
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td style="text-align:center;">
                ${p.numero}ª Semana<br>
                <small>${dataTexto}</small>
              </td>
              <td contenteditable="true">${p.unidade_tematica || ""}</td>
              <td contenteditable="true">${p.objetivo_especifico || ""}</td>
              <td contenteditable="true">${p.conteudo || ""}</td>
              <td contenteditable="true">${p.competencia_basica || ""}</td>
              <td contenteditable="true">${p.carga_horaria || ""}</td>
            `;
            tbody.appendChild(tr);
          });
        }

        document.getElementById('planoFinal').style.display = 'block';
        document.getElementById('btnVoltarFormulario').style.display = 'inline-block';

        const planoData = { zipNome, zipNumero: zipNum, classe: c, disciplina: d, trimestre: t };
        sessionStorage.setItem("planoData", JSON.stringify(planoData));

      } catch (e) {
        console.error(e);
        alert("Erro ao carregar plano.");
        voltarAoFormulario();
      }
    }
  </script>
</body>
</html>
