<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pagamento - Plano de Aula</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
<style>
body { font-family: Times, sans-serif; background:#f4f4f9; padding:20px; text-align:center; }
h2 { color:#007bff; }
button { padding:12px 20px; font-size:16px; font-weight:bold; border:none; border-radius:12px; background:#007bff; color:white; cursor:pointer; transition:0.3s; }
button:hover { background:#0056b3; }
#mensagem { margin-top:15px; font-size:15px; font-weight:bold; }
#formPagamento { margin-top:20px; display:none; }
input[type="tel"] { padding:10px; font-size:16px; width:220px; border:2px solid #007bff; border-radius:8px; text-align:center; }
.benja-spinner { width: 0.30cm; height: 0.75cm; border: 0.12cm solid rgba(0, 123, 255, 0.25); border-top: 0.12cm solid #007BFF; border-radius: 50%; display: inline-block; animation: benja-spin 0.9s linear infinite; vertical-align: middle; margin-right: 10px; }
@keyframes benja-spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
.benja-loading { display: inline-flex; align-items: center; color: #007BFF; font-family: Times; font-size: 16px; }
</style>
</head>
<body>
  <h2 id="tituloPagamento">Pagamento Necess√°rio para Baixar o Plano em PDF</h2>
  <p id="textoPagamento1">Para exportar o PDF do seu Plano de Aula, efectue o pagamento de <strong>5 MTs</strong>.</p>
  <p id="textoPagamento2">Escolha o M√©todo de Pagamento mais ideal para tiüëá.</p>

  <button id="btnPagar" onclick="mostrarFormulario(); ocultarElementos('btnEmola')" 
    style="background-color: #4CAF50; color: black; font-size: 16px; font-family: 'Times New Roman', Times, serif; font-weight: bold; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.2); transition: all 0.3s ease; display: block; margin-bottom: 1cm;"
    onmouseover="this.style.backgroundColor='#45a049'; this.style.transform='scale(1.05)';"
    onmouseout="this.style.backgroundColor='#4CAF50'; this.style.transform='scale(1)';">
    üí≥ Fazer Pagamento Autom√°tico via Mpesa
  </button>

  <a id="btnEmola" href="pagamentoemola.html" 
     onclick="ocultarElementos('btnPagar')"
     style="display: inline-block; background-color: #FFD700; color: #000; font-weight: bold; font-size: 16px; padding: 12px 24px; border-radius: 8px; text-decoration: none; box-shadow: 0 4px 8px rgba(0,0,0,0.2); transition: all 0.3s ease;"
     onmouseover="this.style.backgroundColor='#FFC107'; this.style.transform='scale(1.05)';"
     onmouseout="this.style.backgroundColor='#FFD700'; this.style.transform='scale(1)';">
     üí∞ Fazer Pagamento Manual via Emola
  </a>

  <div id="formPagamento">
    <p>Digite o n√∫mero do seu <strong>Mpesa</strong> (84 / 85):</p>
    <input type="tel" id="numeroMpesa" placeholder="Ex: 84xxx..." maxlength="9" pattern="8[45][0-9]{7}" autocomplete="off">
    <br><br>
    <button onclick="confirmarPagamento()">Confirmar</button>
  </div>
  <div id="mensagem"></div>

  <!-- Json para Termos de Responzabilidade -->
  <div id="x1" data-v="ZjcyMzMyN2M0OWRjNzI3ZjA1MTVkMjk3NTZmNWQ2OTE=" style="display:none"></div>
  <div id="x2" data-v="Y2I2MzFkMGU1NzM4MWE5MmViNTE5M2RlMGU5ZTg2Yjc=" style="display:none"></div>
  <div id="x3" data-v="ODVlOGFhOTA5NDMwMzRiNjQ4YjY1MzM3OTkwYzdiMWI=" style="display:none"></div>
  <div id="x4" data-v="NDliNDZlNmJhOWM4ZGJjZWE4Y2E5MTg1YmQwOTdhMDQ=" style="display:none"></div>
  <div id="w" data-v="NTQ4ZjYxMTctY2I2NS00ZmFmLTk2NjUtMzU2MWQxM2E0YmEz" style="display:none"></div>

  <script>
    function rev(s) { return s.split('').reverse().join(''); }
    function getApiKey() {
      const p1 = atob(document.getElementById('x1').dataset.v);
      const p2 = atob(document.getElementById('x2').dataset.v);
      const p3 = atob(document.getElementById('x3').dataset.v);
      const p4 = atob(document.getElementById('x4').dataset.v);
      return [p1, p2, p3, p4].join('');
    }
    function getWalletId() {
      return atob(document.getElementById('w').dataset.v);
    }

    function ocultarElementos(idOutro) {
      document.getElementById(idOutro).style.display = 'none';
      document.getElementById('textoPagamento2').style.display = 'none';
    }

    function mostrarFormulario() {
      document.getElementById("btnPagar").style.display = "none";
      document.getElementById("formPagamento").style.display = "block";
    }

    async function confirmarPagamento() {
      const phoneInput = document.getElementById("numeroMpesa").value.trim();
      const msg = document.getElementById("mensagem");

      if (!/^8(4|5)\d{7}$/.test(phoneInput)) {
        msg.style.color = "#dc3545";
        msg.innerText = "‚ö†Ô∏è Insira um n√∫mero v√°lido de Mpesa come√ßando com 84 ou 85.";
        return;
      }

      msg.style.color = "#007BFF";
      msg.innerHTML = `
        <span class="benja-loading">
          <span class="benja-spinner" aria-hidden="true"></span>
          <span>Processando Pagamento para ${phoneInput}</span>
        </span>
      `;
      document.getElementById("numeroMpesa").value = "";

      try {
        const response = await fetch("https://gibrapay.online/v1/transfer", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "API-Key": getApiKey() //API_Key: "75hndjYvk_yyjsi862ibUbskYbnCk6_Knsv588hsGGhjsm"
          },
          body: JSON.stringify({
            wallet_id: getWalletId(), //Wallet_id: "76hinGT_758hnYNFyks77CFjsmpR647i_bihTT8Gh"
            amount: 5,
            number_phone: phoneInput
          })
        });

        const data = await response.json();
        if (data.status === "success") {
          msg.style.color = "#28a745";
          msg.innerText = "‚úÖ Pagamento confirmado! Gerando PDF...";
          gerarPDF();
        } else {
          msg.style.color = "#dc3545";
          msg.innerText = "‚ùå " + (data.message || "Falha no pagamento.");
        }
      } catch (err) {
        console.error("Erro:", err);
        msg.style.color = "#dc3545";
        msg.innerText = "‚ùå Erro de conex√£o com o servidor.";
      }
    }

    // === FUN√á√ÉO: GERAR PDF DE PLANO DE AULA (INALTERADA) ===
function gerarPdfPlanoAula(doc, planoData) {
  doc.setFont("times", "normal");
  doc.setFontSize(12);
  doc.text("PLANO DE AULA", 148, 12, { align: "center" });

  const tempDiv = document.createElement('div');
  tempDiv.innerHTML = planoData.html;

  let yLeft = 25;
  const addLineLeft = (label, value) => {
    if (value) {
      doc.text(`${label}:`, 10, yLeft);
      doc.text(value, 55, yLeft);
      yLeft += 6;
    }
  };
  const dadosEsquerda = tempDiv.querySelector('#dadosEsquerda');
  if (dadosEsquerda) {
    const esquerdaText = dadosEsquerda.innerText;
    const lines = esquerdaText.split('\n');
    lines.forEach(line => {
      if (line.includes(':')) {
        const [label, value] = line.split(':', 2);
        addLineLeft(label.trim(), value.trim());
      }
    });
  }

  let yRight = 25;
  const addLineRight = (label, value) => {
    if (value) {
      doc.text(`${label}:`, 160, yRight);
      doc.text(value, 200, yRight);
      yRight += 6;
    }
  };
  const dadosDireita = tempDiv.querySelector('#dadosDireita');
  if (dadosDireita) {
    const direitaText = dadosDireita.innerText;
    const lines = direitaText.split('\n');
    lines.forEach(line => {
      if (line.includes(':')) {
        const [label, value] = line.split(':', 2);
        addLineRight(label.trim(), value.trim());
      }
    });
  }

  let lastY = Math.max(yLeft, yRight);
  const listaObjetivos = tempDiv.querySelector('#listaObjetivos');
  if (listaObjetivos) {
    doc.text("Objetivos Espec√≠ficos:", 10, lastY + 5);
    let yObj = lastY + 12;
    const objetivos = listaObjetivos.querySelectorAll('li');
    objetivos.forEach(obj => {
      const texto = obj.innerText.trim();
      if (texto) {
        doc.text(texto, 15, yObj);
        yObj += 6;
      }
    });
    lastY = yObj;
  }

  const tabela = tempDiv.querySelector('#tabelaPlano');
  if (tabela) {
    const rows = tabela.querySelectorAll('tbody tr');
    const tableData = Array.from(rows).map(row => {
      const cells = row.querySelectorAll('td');
      return Array.from(cells).map(cell => {
        let text = cell.innerHTML
          .replace(/<br\s*\/?>/gi, '\n')
          .replace(/<[^>]*>/g, '');
        return text.trim();
      });
    });
    doc.autoTable({
      startY: lastY + 3,
      head: [['TEMPO', 'FUN√á√ïES DID√ÅCTICAS', 'CONTE√öDOS', 'ACTIVIDADES DO PROFESSOR', 'ACTIVIDADES DOS ALUNOS', 'M√âTODOS DE ENSINO', 'MEIOS DE ENSINO']],
      body: tableData,
      theme: 'grid',
      styles: {
        font: 'times',
        fontSize: 12,
        textColor: [0,0,0],
        lineColor: [0,0,0],
        lineWidth: 0.2,
        cellPadding: 3,
        valign: 'top',
        overflow: 'linebreak'
      },
      headStyles: {
        fillColor: [200,200,200],
        textColor: [0,0,0],
        font: 'times',
        fontSize: 12,
        fontStyle: 'bold'
      },
      columnStyles: {
        0: { cellWidth: 18 },
        1: { cellWidth: 35 },
        2: { cellWidth: 'auto' },
        3: { cellWidth: 'auto' },
        4: { cellWidth: 'auto' },
        5: { cellWidth: 30 },
        6: { cellWidth: 30 }
      },
      margin: { top: 15, bottom: 10, left: 7, right: 7 },
      tableWidth: 'auto',
      showHead: 'firstPage',
      didDrawCell: function (data) {
        if (data.section === 'body' && [0,1,5].includes(data.column.index)) {
          data.cell.styles.valign = 'top';
        }
      }
    });
  }

  // === ANEXO (mantido exatamente como estava) ===
  (function renderAnexo() {
    if (!planoData) return;
    const anexType = planoData.anexoTipo || (planoData.anexoSalvo && planoData.anexoSalvo.tipo) || null;
    const anexImg = planoData.anexoImagem || (planoData.anexoSalvo && planoData.anexoSalvo.tipo === 'imagem' && planoData.anexoSalvo.data) || null;
    const anexTxtRaw = (planoData.anexoTexto && String(planoData.anexoTexto).trim() !== '')
      ? planoData.anexoTexto
      : (planoData.anexoSalvo && planoData.anexoSalvo.tipo === 'texto' ? planoData.anexoSalvo.data : null);
    const emojiRegex = /[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F1E0}-\u{1F1FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}]/gu;
    const anexTxt = anexTxtRaw ? anexTxtRaw.replace(emojiRegex, '') : null;
    if (!anexType || (!anexImg && !anexTxt)) return;
    const margemX = 20;
    const pageWidth = doc.internal.pageSize.getWidth();
    const largura = Math.min(pageWidth - 2 * margemX, 250);
    let alturaBox = anexType === 'imagem' ? 100 : 40;
    if (anexTxt && anexType === 'texto') {
      const lines = doc.splitTextToSize(anexTxt, largura - 10);
      alturaBox = Math.max(40, Math.min(200, 10 + lines.length * 6));
    }
    let posY = 20;
    if (doc.lastAutoTable && doc.lastAutoTable.finalY) {
      posY = doc.lastAutoTable.finalY + 8;
    } else if (typeof doc.getY === 'function') {
      try { posY = doc.getY() + 8; } catch (e) { posY = 20; }
    }
    const pageHeight = doc.internal.pageSize.getHeight();
    const bottomMargin = 10;
    if (posY + alturaBox + bottomMargin > pageHeight) {
      doc.addPage();
      posY = 15;
    }
    doc.setDrawColor(0, 0, 0);
    doc.rect(margemX, posY, largura, alturaBox);
    doc.setFont("Times", "bold");
    doc.setFontSize(12);
    doc.text("ANEXO", margemX + largura / 2, posY + 8, { align: "center" });
    if (anexType === "imagem" && anexImg) {
      let fmt = 'PNG';
      try {
        const m = anexImg.match(/^data:image\/([a-zA-Z0-9+]+);base64,/);
        if (m && m[1]) fmt = m[1].toUpperCase();
      } catch (e) {}
      const imgX = margemX + 5;
      const imgY = posY + 12;
      const imgW = largura - 10;
      const imgH = alturaBox - 18;
      try {
        doc.addImage(anexImg, fmt, imgX, imgY, imgW, imgH);
      } catch (e) {
        doc.setFont("Times", "normal");
        doc.setFontSize(12);
        doc.text("Erro ao inserir imagem do anexo.", margemX + 5, posY + 18);
      }
    } else if (anexType === "texto" && anexTxt) {
      doc.setFont("Times", "normal");
      doc.setFontSize(12);
      const txtLines = doc.splitTextToSize(anexTxt, largura - 10);
      doc.text(txtLines, margemX + 5, posY + 15, {
        align: 'justify',
        maxWidth: largura - 10
      });
    }
  })();
}

// === FUN√á√ÉO: GERAR PDF DE PLANO QUINZENAL (NOVA) ===
function gerarPdfPlanoQuinzenal(doc, planoData) {
  doc.setFont("times", "normal");
  doc.setFontSize(12);
  doc.text("PLANO QUINZENAL", 148, 12, { align: "center" });

  const tempDiv = document.createElement('div');
  tempDiv.innerHTML = planoData.html;

  // Extrair e renderizar o cabe√ßalho do ZIP
  let startY = 25;
  const cabecalhoEl = tempDiv.querySelector('#cabecalhoZip');
  if (cabecalhoEl) {
    const cabecalhoTexto = cabecalhoEl.innerText;
    const lines = doc.splitTextToSize(cabecalhoTexto, 280);
    lines.forEach((line, i) => {
      doc.text(line, 148, startY + i * 6, { align: "center" });
    });
    startY += lines.length * 6 + 8;
  }

  // Renderizar a tabela
  const tabela = tempDiv.querySelector('#tabelaPlano');
  if (tabela) {
    const rows = tabela.querySelectorAll('tbody tr');
    const tableData = Array.from(rows).map(row => {
      const cells = row.querySelectorAll('td');
      return Array.from(cells).map(cell => {
        let text = cell.innerHTML
          .replace(/<br\s*\/?>/gi, '\n')
          .replace(/<[^>]*>/g, '');
        return text.trim();
      });
    });

    const headers = Array.from(tabela.querySelectorAll('thead th')).map(th => th.innerText);

    doc.autoTable({
      startY: startY,
      head: [headers],
      body: tableData,
      theme: 'grid',
      styles: {
        font: 'times',
        fontSize: 12,
        textColor: [0,0,0],
        lineColor: [0,0,0],
        lineWidth: 0.2,
        cellPadding: 3,
        valign: 'top',
        overflow: 'linebreak'
      },
      headStyles: {
        fillColor: [200,200,200],
        textColor: [0,0,0],
        font: 'times',
        fontSize: 12,
        fontStyle: 'bold'
      },
      margin: { top: 15, bottom: 10, left: 7, right: 7 },
      tableWidth: 'auto',
      showHead: 'firstPage'
    });
  }

  // Anexo (opcional, reutiliza a mesma l√≥gica)
  (function renderAnexo() {
    if (!planoData) return;
    const anexType = planoData.anexoTipo || (planoData.anexoSalvo && planoData.anexoSalvo.tipo) || null;
    const anexImg = planoData.anexoImagem || (planoData.anexoSalvo && planoData.anexoSalvo.tipo === 'imagem' && planoData.anexoSalvo.data) || null;
    const anexTxtRaw = (planoData.anexoTexto && String(planoData.anexoTexto).trim() !== '')
      ? planoData.anexoTexto
      : (planoData.anexoSalvo && planoData.anexoSalvo.tipo === 'texto' ? planoData.anexoSalvo.data : null);
    const emojiRegex = /[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F1E0}-\u{1F1FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}]/gu;
    const anexTxt = anexTxtRaw ? anexTxtRaw.replace(emojiRegex, '') : null;
    if (!anexType || (!anexImg && !anexTxt)) return;
    const margemX = 20;
    const pageWidth = doc.internal.pageSize.getWidth();
    const largura = Math.min(pageWidth - 2 * margemX, 250);
    let alturaBox = anexType === 'imagem' ? 100 : 40;
    if (anexTxt && anexType === 'texto') {
      const lines = doc.splitTextToSize(anexTxt, largura - 10);
      alturaBox = Math.max(40, Math.min(200, 10 + lines.length * 6));
    }
    let posY = 20;
    if (doc.lastAutoTable && doc.lastAutoTable.finalY) {
      posY = doc.lastAutoTable.finalY + 8;
    } else if (typeof doc.getY === 'function') {
      try { posY = doc.getY() + 8; } catch (e) { posY = 20; }
    }
    const pageHeight = doc.internal.pageSize.getHeight();
    const bottomMargin = 10;
    if (posY + alturaBox + bottomMargin > pageHeight) {
      doc.addPage();
      posY = 15;
    }
    doc.setDrawColor(0, 0, 0);
    doc.rect(margemX, posY, largura, alturaBox);
    doc.setFont("Times", "bold");
    doc.setFontSize(12);
    doc.text("ANEXO", margemX + largura / 2, posY + 8, { align: "center" });
    if (anexType === "imagem" && anexImg) {
      let fmt = 'PNG';
      try {
        const m = anexImg.match(/^data:image\/([a-zA-Z0-9+]+);base64,/);
        if (m && m[1]) fmt = m[1].toUpperCase();
      } catch (e) {}
      const imgX = margemX + 5;
      const imgY = posY + 12;
      const imgW = largura - 10;
      const imgH = alturaBox - 18;
      try {
        doc.addImage(anexImg, fmt, imgX, imgY, imgW, imgH);
      } catch (e) {
        doc.setFont("Times", "normal");
        doc.setFontSize(12);
        doc.text("Erro ao inserir imagem do anexo.", margemX + 5, posY + 18);
      }
    } else if (anexType === "texto" && anexTxt) {
      doc.setFont("Times", "normal");
      doc.setFontSize(12);
      const txtLines = doc.splitTextToSize(anexTxt, largura - 10);
      doc.text(txtLines, margemX + 5, posY + 15, {
        align: 'justify',
        maxWidth: largura - 10
      });
    }
  })();
}

// === L√ìGICA PRINCIPAL: ESCOLHER QUAL FUN√á√ÉO USAR ===
const planoDataJSON = sessionStorage.getItem("planoData");
if (!planoDataJSON) {
  alert("‚ùå Nenhum plano encontrado. Gere o plano antes de tentar desbloquear.");
  return;
}
const planoData = JSON.parse(planoDataJSON);
const { jsPDF } = window.jspdf;
const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });

// Escolher fun√ß√£o com base no tipo
if (planoData.tipoPlano === "quinzenal") {
  gerarPdfPlanoQuinzenal(doc, planoData);
} else {
  gerarPdfPlanoAula(doc, planoData);
}

// === NOME DO ARQUIVO ===
let nome;
if (planoData.tipoPlano === "quinzenal") {
  const ano = new Date().getFullYear();
  nome = `Plano_Quinzenal_${planoData.disciplina}_${planoData.classe}_${planoData.trimestre.replace(/\s+/g, '_')}_${ano}.pdf`;
} else {
  nome = `Plano_de_Aula_${planoData.disciplina}_${planoData.classe}_${planoData.data}.pdf`;
}
doc.save(nome);

// === HIST√ìRICO ===
const historico = JSON.parse(localStorage.getItem("historicoPlanos")) || [];
let entradaHistorico;
if (planoData.tipoPlano === "quinzenal") {
  const ano = new Date().getFullYear();
  entradaHistorico = {
    tipoPlano: "quinzenal",
    disciplina: planoData.disciplina,
    classe: planoData.classe,
    trimestre: planoData.trimestre,
    ano: ano,
    zipNome: planoData.zipNome,
    zipNumero: planoData.zipNumero
  };
} else {
  entradaHistorico = {
    tipoPlano: "aula",
    escola: planoData.escola,
    professor: planoData.professor,
    disciplina: planoData.disciplina,
    unidade: planoData.unidade,
    tema: planoData.tema,
    tipo: planoData.tipo,
    classe: planoData.classe,
     planoData.data
  };
}
historico.push(entradaHistorico);
localStorage.setItem("historicoPlanos", JSON.stringify(historico));

msg.style.color = "#28a745";
msg.innerText = `üéâ C√≥digo v√°lido! PDFs restantes: ${data.restante}`;
alert("‚úÖ PDF desbloqueado e baixado com sucesso!");
    }
  </script>
</body>
</html>
